<!DOCTYPE html>
<html>

<head>
    <title>系统配置</title>
    <% include header.html %>
</head>
<style>
    .addpush {
        cursor: pointer;
        color: #3c8dbc;
    }
</style>

<body class="hold-transition skin-blue-light">
    <div class="wrapper" style="padding:20px 40px 0 30px;">
        <!-- add page content start -->
        <div class="row">
            <div class="col-sm-12">
                <div class="row">
                    <div class="box box-default">
                        <div class="box-header with-border">
                            <h3 class="box-title">EasyDSS UMS管理系统</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                            </div>
                            <!-- /.box-tools -->
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body " style="display: block;">

                            <form class="form-horizontal" style="margin:auto">
                                <div class="form-group">
                                    <label for="sys_node_port" class="col-sm-2 control-label">WEB管理端口</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="sys_node_port" placeholder="WEB管理端口" value="<%-NodeServerHTTPPort%>" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2"></div>
                                    <div class="col-sm-10">说明：端口可以修改server.js的第一行，然后重新启动 ./node/bin/restartnode
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="sys_node_version" class="col-sm-2 control-label">当前版本</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="sys_node_version" placeholder="当前版本" readonly="true" value="<%-version%>">
                                    </div>
                                </div>
                                <!--<div class="form-group">
                                    <div class="row pull-right">
                                        <button type="button" id="btn_reset_node" class="btn btn-block btn-danger btn-sm" style="width:150px;margin-right:30px;"><i class="fa  fa-circle"></i>&nbsp;&nbsp;&nbsp;保存并重启WEB管理</button>
                                    </div>
                                </div>-->
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-12">
                <div class="row">
                    <div class="box box-default " style="margin-left:10px;">
                        <div class="box-header with-border">
                            <h3 class="box-title">EasyDSS 流媒体服务</h3>
                            <div class="box-tools pull-right">
                                <button type="button" class="btn btn-box-tool" data-widget="collapse"><i class="fa fa-minus"></i></button>
                            </div>
                            <!-- /.box-tools -->
                        </div>
                        <!-- /.box-header -->
                        <div class="box-body " style="display: block;">

                            <form class="form-horizontal" style="margin:auto" id="dss_config">
                                <div class="form-group">
                                    <label for="HTTPWanPort" class="col-sm-2 control-label">服务HTTP端口</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="HTTPWanPort" placeholder="服务HTTP端口">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="RTMPWanPort" class="col-sm-2 control-label">服务RTMP端口</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="RTMPWanPort" placeholder="服务RTMP端口">
                                    </div>
                                </div>
                                <div class="form-group" style="display:none">
                                    <label for="ServerWanIP" class="col-sm-2 control-label">easydarwin_host</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="ServerWanIP" placeholder="输入IP地址或域名">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="application" class="col-sm-2 control-label">添加RTMP转发推流</label>
                                    <div class="col-sm-10">
                                        <div class="input-group" id="application">
                                            <span class="input-group-addon">选择类型</span>
                                            <div class="input-group-btn">
                                                <select class="form-control" id="push_type" style="width:100px;">
                                                    <%- selectHTML%>
                                                </select>
                                            </div>
                                            <span class="input-group-addon">rtmp://</span>
                                            <input type="text" class="form-control" id="push_host" placeholder="host">
                                            <span class="input-group-addon">:</span>
                                            <input type="text" class="form-control" id="push_port" placeholder="port">
                                            <span class="input-group-addon">/</span>
                                            <input type="text" class="form-control" id="push_application" placeholder="application">
                                            <span class="input-group-addon addpush" onclick="addPush();">添加一条</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2"></div>
                                    <div class="col-sm-10" id="pushlist">
                                        <%- pushHTML%>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="Hardware" class="col-sm-2 control-label">硬件信息</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="Hardware" placeholder="硬件信息" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="InterfaceVersion" class="col-sm-2 control-label">接口版本</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="InterfaceVersion" placeholder="接口版本" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="RunningTime" class="col-sm-2 control-label">运行时间</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="RunningTime" placeholder="运行时间" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="Server" class="col-sm-2 control-label">版本信息</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="Server" placeholder="版本信息" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label for="Validity" class="col-sm-2 control-label">授权信息</label>
                                    <div class="col-sm-10">
                                        <input type="text" class="form-control" id="Validity" placeholder="授权信息" readonly="true">
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="col-sm-2"></div>
                                    <div class="col-sm-10">说明：若提示成功后参数未更改，请稍后点击右上角刷新
                                    </div>
                                </div>
                                <div class="form-group">
                                    <div class="row pull-right">
                                        <button type="button" id="btn_reload_dss" class="btn btn-block btn-danger btn-sm" style="width:180px;margin-right:30px;"><i class="fa fa-dot-circle-o"></i>&nbsp;&nbsp;&nbsp;保存并重启流媒体服务</button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- add page content end -->
    </div>
</body>

</html>
<% include footer.html %>
    <script type="text/javascript" src="../../plugins/jquery-easyui-1.5.1/jquery.easyui.min.js"></script>
    <link rel="stylesheet" type="text/css" href="../../plugins/jquery-easyui-1.5.1/themes/bootstrap/easyui.css">
    <script>
        var host = "http://" + location.host.split(":")[0] + ":<%- HTTPWanPort%>";
        var HTTPWanPort;
        var RTMPWanPort;
        var ServerWanIP;

        initBaseConfig();
        initServerInfo();

        function initServerInfo() {
            $.get(host + "/getserverinfo", function(ret) {
                $("#Hardware").val(ret.EasyDarwin.Body.Hardware);
                $("#InterfaceVersion").val(ret.EasyDarwin.Body.InterfaceVersion);
                $("#RunningTime").val(ret.EasyDarwin.Body.RunningTime);
                $("#Server").val(ret.EasyDarwin.Body.Server);
                $("#Validity").val(ret.EasyDarwin.Body.Validity);
            });
        }

        function initBaseConfig() {
            $.get(host + "/getbaseconfig", function(ret) {
                HTTPWanPort = ret.EasyDarwin.Body.HTTPWanPort;
                RTMPWanPort = ret.EasyDarwin.Body.RTMPWanPort;
                ServerWanIP = ret.EasyDarwin.Body.ServerWanIP;
                $("#HTTPWanPort").val(HTTPWanPort);
                $("#RTMPWanPort").val(RTMPWanPort);
                $("#ServerWanIP").val(ServerWanIP);
            });
        }

        function removePush(id) {
            $("#" + id).remove();
        }
        var k = 1;

        function addPush() {
            var push_type = $("#push_type").val().trim();
            var push_host = $("#push_host").val().trim();
            var push_port = $("#push_port").val().trim();
            var push_application = $("#push_application").val();
            var port = new RegExp(/^([0-9]|[1-9]\d{1,3}|[1-5]\d{4}|6[0-5]{2}[0-3][0-5])$/);
            if (push_type == "") {
                window.parent.alertWarning("请选择类型");
                $("#push_type").focus();
                return;
            }
            if (push_host == "") {
                window.parent.alertWarning("host不能为空");
                $("#push_host").focus();
                return;
            }
            if (push_application == "") {
                window.parent.alertWarning("application不能为空");
                $("#push_application").focus();
                return;
            }
            if (!port.test(push_port) && port != "") {
                window.parent.alertWarning("端口格式不正确");
                $("#push_port").focus();
                return;
            }
            var pushHTML = '<div class="input-group" id="newpush' + k + '">' +
                ' <span class="input-group-addon type">' + push_type + '</span>' +
                ' <span class="input-group-addon url"> rtmp://' + push_host + ':' + push_port + '/' + push_application + '</span>' +
                ' <span class="input-group-addon addpush" onclick="removePush(\'newpush' + k + '\')">移除</span>' +
                ' </div>';
            k++;
            $("#pushlist").append(pushHTML);

            $("#push_application").val("");
            $("#push_host").val("");
            $("#push_port").val("");
        }

        $("#btn_reload_dss").click(function() {
            var pushContent = "";
            $("#pushlist div").each(function() {
                var type = $(this).children("span.type").text();
                var url = $(this).children("span.url").text();
                if (pushContent == "") {
                    pushContent = type + "][" + url;
                } else {
                    pushContent += "><" + type + "][" + url;
                }
            });
            var HTTPWanPortNew = $("#HTTPWanPort").val();
            var RTMPWanPortNew = $("#RTMPWanPort").val();
            var ServerWanIPNew = $("#ServerWanIP").val();

            var ip = new RegExp(/^(\d|[1-9]\d|1\d{2}|2[0-5][0-5])\.(\d|[1-9]\d|1\d{2}|2[0-5][0-5])\.(\d|[1-9]\d|1\d{2}|2[0-5][0-5])\.(\d|[1-9]\d|1\d{2}|2[0-5][0-5])$/);
            var port = new RegExp(/^([0-9]|[1-9]\d{1,3}|[1-5]\d{4}|6[0-5]{2}[0-3][0-5])$/);
            var URL = new RegExp(/^[a-zA-Z0-9_-]+\.[a-zA-Z0-9_-]+(\.[a-zA-Z0-9_-]+)+$/);

            if (!port.test(HTTPWanPortNew)) {
                window.parent.alertWarning("服务HTTP端口格式不正确！");
                $("#HTTPWanPort").focus();
                return;
            }
            if (!port.test(RTMPWanPortNew)) {
                window.parent.alertWarning("服务RTMP端口格式不正确！");
                $("#RTMPWanPort").focus();
                return;
            }
            if (!URL.test(ServerWanIPNew)) {
                window.parent.alertWarning("easydarwin_host格式不正确！");
                $("#ServerWanIP").focus();
                return;
            }

            if (HTTPWanPortNew == RTMPWanPortNew) {
                window.parent.alertWarning("HTTP端口和RTMP端口不能一样！");
                $("#HTTPWanPort").focus();
                return;
            }

            $.messager.confirm('确定', '请确定配置的端口没有被占用，参数不含有非法字符，是否继续保存重启？', function(r) {
                if (r) {
                    window.parent.showPageLoading('sys_config');
                    window.parent.alertSuccess("重启中，请稍后.....");
                    $.ajax({
                        url: 'reloadDSS',
                        type: 'post',
                        data: {
                            HTTPWanPort: HTTPWanPortNew,
                            RTMPWanPort: RTMPWanPortNew,
                            ServerWanIP: ServerWanIPNew,
                            pushContent: pushContent,
                        },
                        success: function(data) {
                            window.parent.hideLoading('sys_config');
                            if (data.result == 1) {
                                host = "http://" + location.host.split(":")[0] + ":" + HTTPWanPortNew;
                                window.parent.removeAlertPrompt();
                                window.parent.alertSuccess(data.msg);
                                initBaseConfig();
                            } else {
                                window.parent.alertError(data.msg);
                            }
                        }
                    });
                }
            });
        });
    </script>